\section{Syntax and Reduction}

\input{figures/02/syntax.tex}
\input{figures/02/reduction.tex}

Syntax for the system is defined generically as before.
See Figure~\ref{fig:syntax} for a complete description.
For the moment the new syntactic forms are merely raw data with no logical or computational meaning.
Nevertheless, a basic fact about substitution on syntax is provable.

\begin{lemma}
    If $x \neq y$ and $y \notin FV(a)$ then \begin{tightcenter} $[x := a][y := b]t = [y := [x := a]b][x := a]t$ \end{tightcenter}
    \label{lem:2:subst_commute}
\end{lemma}
\begin{proof}
    By induction on $t$.
    If $t$ is a binder or a constructor, then substitution unfolds and the IH applied to subterms concludes those cases.
    Suppose $t$ is a variable, $z$.
    If $z = x$, then $z \neq y$ and $t = a$ on both sides because $y \notin FV(a)$.
    If $z = y$, then $z \neq x$ and $t = [x := a]b$ on both sides.
    If $z \neq x$ and $z \neq y$, then $t = z$ on both sides.
\end{proof}

Computational meaning is added via reduction rules described in Figure~\ref{fig:reduction}.
The new reductions model projection of pairs (e.g. $[t_1, t_2, t_3].1 \betared t_1$), promotion of equalities (e.g. $\vartheta_1(\text{refl}(t_1), t_2, t_3) \betared \text{refl}(t_2)$) and an elimination form for equality.
Note that conversion is different from a traditional PTS.
Convertibility with respect to reduction is written: $t \betaconv s$.
A detailed discussion of conversion is delayed until Section~\ref{sec:2:erasure}.

Before more important facts about reduction can be discussed it is important to observe the interaction between reduction and substitution.
First, note that multistep reduction (i.e. the reflexive-transitive closure of the reduction relation) is congruent with respect to syntax.
Second, substitution is shown to commute with multistep reduction through a series of lemmas.

\begin{lemma}
    If $t_i \betastar t_i^\prime$ for any $i$ then,
    \begin{enumerate}
        \item $\mathfrak{b}(\kappa, (x : t_1), t_2) \betastar \mathfrak{b}(\kappa, (x : t_1^\prime), t_2^\prime)$
        \item $\mathfrak{c}(\kappa, t_1,\ldots,t_{\mathfrak{a}(\kappa)}) \betastar \mathfrak{c}(\kappa, t_1^\prime,\ldots,t_{\mathfrak{a}(\kappa)}^\prime)$
    \end{enumerate}
    \label{lem:2:beta_par}
\end{lemma}
\begin{proof}
    Pick any $i$ and apply the reductions to the associate subterm.
    A straightforward induction on $t_i \betastar t_i^\prime$ demonstrates that the reductions apply only to the associated subterm.
    Repeat until all $i$ reductions are applied.
\end{proof}

\begin{lemma}
    If $a \betared b$ then $[x := t]a \betared [x := t]b$
    \label{lem:2:betared_subst}
\end{lemma}
\begin{proof}
    By induction on $a \betared b$.

    $\text{Case: }\begin{array}{c} \app{(\abs{\lambda_m}{x}{A}{b})}{m}{t} \betared [x := t]b \end{array}$
    \begin{proofcase}
        $[x := s](\app{(\abs{\lambda_m}{y}{A}{b})}{m}{t}) = \app{(\abs{\lambda_m}{x}{[x := s]A}{[x := s]b})}{m}{[x := s]t} \betared [y := [x := s]t][x := s]b = [x := s][y := t]b$ \\
        Note that the final equality holds by Lemma~\ref{lem:2:subst_commute}.
    \end{proofcase}

    $\text{Case: }\begin{array}{c} [t_1, t_2; A].1 \betared t_1 \end{array}$
    \begin{proofcase}
        $[x := t][t_1, t_2, A].1 = [[x := t]t_1, [x := t]t_2, [x := ]A].1 \betared [x := t]t_1$
    \end{proofcase}

    $\text{Case: }\begin{array}{c} [t_1, t_2; A].2 \betared t_2 \end{array}$
    \begin{proofcase}
        $[x := t][t_1, t_2, A].2 = [[x := t]t_1, [x := t]t_2, [x := ]A].2 \betared [x := t]t_2$
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \psi(\text{refl}(t),P) \betared \abs{\lambda_\omega}{x}{\apptwo{P}{\tau}{t}{\tau}{\text{refl}(t)}}{x} \end{array}$
    \begin{proofcase}
        $[x := s]\psi(\text{refl(t)}, P) = \psi(\text{refl}([x := s]t), [x := s]P) \betared \abs{\lambda_\omega}{y}{\apptwo{[x := s]P}{\tau}{[x := s]t}{\tau}{\text{refl}([x := s]t)}}{y} = [x := s](\abs{\lambda_\omega}{y}{\apptwo{P}{\tau}{t}{\tau}{\text{refl}(t)}}{y})$
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \vartheta_1(\text{refl}(t_1), t_2, t_3) \betared \text{refl}(t_2) \end{array}$
    \begin{proofcase}
        $[x := s]\vartheta_1(\text{refl}(t_1), t_2, t_3) = \vartheta_1(\text{refl}(([x := s]t_1)), [x := s]t_2, [x := s]t_3) \betared \text{refl}([x := s]t_2) = [x := s]\text{refl}(t_2)$
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \vartheta_2(\text{refl}(t_1), t_2, t_3) \betared \text{refl}(t_2) \end{array}$
    \begin{proofcase}
        $[x := s]\vartheta_2(\text{refl}(t_1), t_2, t_3) = \vartheta_2(\text{refl}(([x := s]t_1)), [x := s]t_2, [x := s]t_3) \betared \text{refl}([x := s]t_2) = [x := s]\text{refl}(t_2)$
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \ConstructorReduction[*] \end{array}$
    \begin{proofcase}
        By the IH, $[x := t]t_i \betared [x := t]t_i^\prime$.
        Note that $$[x := t]\mathfrak{c}(\kappa, t_1, \ldots, t_{\mathfrak{a}}(\kappa)) = \mathfrak{c}(\kappa, [x := t]t_1, \ldots, [x := t]t_{\mathfrak{a}}(\kappa))$$
        Applying the constructor reduction rule and reversing the previous equality concludes the case.
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \BinderOneReduction[*] \end{array}$
    \begin{proofcase}
        By the IH, $[x := t]t_1 \betared [x := t]t_1^\prime$.
        Note that $$[x := t]\mathfrak{b}(\kappa, (y : t_1), t_2) = \mathfrak{b}(\kappa, (y : [x := t]t_1), [x := t]t_2)$$
        Applying the first binder reduction rule and reversing the previous equality concludes the case.
    \end{proofcase}
\end{proof}

\begin{lemma}
    If $a \betastar b$ then $[x := t]a \betastar [x := t]b$
    \label{lem:2:betastar_subst_weak1}
\end{lemma}
\begin{proof}
    By induction on $a \betastar b$.
    The reflexivity case is trivial.

    $\text{Case: }\begin{array}{c} \MultiStep[*] \end{array}$
    \begin{proofcase}
        Let $z = t^\prime$.
        By the IH applied to $\D{2}$: $[x := t]z \betastar [x := t]b$.
        By Lemma~\ref{lem:2:betared_subst} applied to $\D{1}$: $[x := t]a \betared [x := t]b$.
        Applying the transitivity rule yields $[x := t]a \betastar [x := t]b$.
    \end{proofcase}
\end{proof}

\begin{lemma}
    If $s \betared t$ then $[x := s]a \betastar [x := t]a$
    \label{lem:2:betastar_subst_weak2}
\end{lemma}
\begin{proof}
    By induction on $a$.

    $\text{Case: }\begin{array}{c} x \end{array}$
    \begin{proofcase}
        Rename $y$.
        Suppose $x = y$, then $[x := s]y = s \betared t = [x := t]y$.
        Thus, $[x := s]y \betastar [x := t]y$.
        Suppose $x \neq y$, then $[x := s]y = y \betastar y = [x := t]y$.
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \mathfrak{b}(\kappa_1, x : t_1, t_2) \end{array}$
    \begin{proofcase}
        By the IH $[x := s]t_1 \betastar [x := t]t_1$ and $[x := s]t_2 \betastar [x := t]t_2$.
        Lemma~\ref{lem:2:beta_par} concludes the case.
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \mathfrak{c}(\kappa_2, t_1, \ldots, t_{\mathfrak{a}(\kappa_2)}) \end{array}$
    \begin{proofcase}
        By the IH $[x := s]t_i \betastar [x := t]t_i$ for all $i$.
        Lemma~\ref{lem:2:beta_par} concludes the case.
    \end{proofcase}
\end{proof}

\begin{lemma}
    If $s \betastar t$ and $a \betastar b$ then $[x := s]a \betastar [x := t]b$
    \label{lem:2:betastar_subst}
\end{lemma}
\begin{proof}
    By induction on $s \betastar t$.
    The reflexivity case is Lemma~\ref{lem:2:betastar_subst_weak1}.

    $\text{Case: }\begin{array}{c} \MultiStep[*] \end{array}$
    \begin{proofcase}
        Let $z = t^\prime$.
        By the IH applied to $\D{2}$: $[x := z]a \betastar [x := t]b$.
        Lemma~\ref{lem:2:betastar_subst_weak2} yields $[x := s]a \betastar [x := z]a$.
        Transitivity concludes with $[x := s]a \betastar [x := t]b$.
    \end{proofcase}
\end{proof}

Lemma~\ref{lem:2:betastar_subst} is the only fact about the interaction of substitution and reduction that is needed moving forward.
A straightforward consequence is a similar lemma about substitution commuting with convertibility w.r.t. reduction.

\begin{lemma}
    If $s \betaconv t$ and $a \betaconv b$ then $[x := s]a \betaconv [x := t]b$
    \label{lem:2:betaconv_subst}
\end{lemma}
\begin{proof}
    By definition $\exists\ z_1, z_2$ such that $t \betastar z_1$, $s \betastar z_1$, $a \betastar z_2$, and $b \betastar z_2$.
    Applying Lemma~\ref{lem:2:betastar_subst} twice yields $[x := s]a \betastar [x := z_1]z_2$ and $[x := t]b \betastar [x := z_1]z_2$.
\end{proof}

Transitivity, as before, is a consequence of confluence.
Confluence is not an obvious property to obtain and can also be an involved property to prove.
For example, a natural variant for the $\vartheta_1$ reduction rule is $\vartheta_1(\text{refl}(t.1)) \betared \text{refl}(t)$, but this breaks confluence.
To see why, consider $\vartheta_1(\text{refl}([x, y, z].1))$.
One choice leads to $\vartheta_1(\text{refl}(x))$, and the other leads to $\text{refl}(x)$.
However, these terms are not joinable, hence confluence fails.
The full proof of confluence is relegated to Appendix~\ref{ap:a}, but note that the approach closely follows the PLFA book \cite{plfa22.08}.

\begin{lemma}[Confluence]
    If $s \betastar t_1$ and $s \betastar t_2$ then $\exists\ t^\prime$ such that $t_1 \betastar t^\prime$ and $t_2 \betastar t^\prime$
\end{lemma}
\begin{proof}
    See Appendix~\ref{ap:a}.
\end{proof}

As with F$^\omega$ the important consequence of confluence is that conversion w.r.t. reduction is an equivalence relation.
However, this is \textit{not} the conversion relation that will be used in the inference judgment.
Thus, while important, it is still only a stepping stone to showing judgmental conversion is transitive.

\begin{lemma}
    For any $s$ and $t$ the relation $s \betaconv t$ is an equivalence.
    \label{lem:2:beta_conv_equivalence}
\end{lemma}
\begin{proof}
    Reflexivity is immediate because $s \betastar s$.
    Symmetry is also immediate because if $s \betaconv t$ then $\exists\ z$ such that $s \betastar z$ and $t \betastar z$, but logical conjunction is commutative.
    Transitivity is a consequence of confluence, see Theorem~\ref{thm:1:trans}.
\end{proof}

Additionally, there is a final useful fact about convertibility w.r.t. reduction that is occasionally used throughout the rest of this work.
That is, like reduction, conversion w.r.t. reduction of subexpressions yields conversion of the entire term.

\begin{lemma}
    If $t_i \betaconv t_i^\prime$ for any $i$ then,
    \begin{enumerate}
        \item $\mathfrak{b}(\kappa, (x : t_1), t_2) \betaconv \mathfrak{b}(\kappa, (x : t_1^\prime), t_2^\prime)$
        \item $\mathfrak{c}(\kappa, t_1,\ldots,t_{\mathfrak{a}(\kappa)}) \betaconv \mathfrak{c}(\kappa, t_1^\prime,\ldots,t_{\mathfrak{a}(\kappa)}^\prime)$
    \end{enumerate}
    \label{lem:2:conv_congr}
\end{lemma}
\begin{proof}
    By Lemma~\ref{lem:2:beta_par} applied on both sides.
\end{proof}
