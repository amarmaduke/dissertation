\section{Preservation}

\begin{theorem}
    \textcolor{white}{\_}
    \begin{enumerate}
        \item $\Gamma \vdash t \infr A$ and $\Gamma \betared \Gamma^\prime$ then $\exists\ A^\prime.$ $A \betastar A^\prime$ and $\Gamma^\prime \vdash t \infr A^\prime$
        \item $\Gamma \vdash t \cinfr A$ and $\Gamma \betared \Gamma^\prime$ then $\exists\ A^\prime.$ $A \betastar A^\prime$ and $\Gamma^\prime \vdash t \cinfr A^\prime$
        \item $\Gamma \vdash t \chck A$ and $\Gamma \betared \Gamma^\prime$ then $\Gamma^\prime \vdash t \chck A$
        \item $\vdash \Gamma$ and $\Gamma \betared \Gamma^\prime$ then $\vdash \Gamma^\prime$
        \item $\Gamma \vdash t \infr A$ and $t \betared t^\prime$ then $\exists\ A^\prime.$ $A \equiv A^\prime$ and $\Gamma \vdash t^\prime \infr A^\prime$
        \item $\Gamma \vdash t \cinfr A$ and $t \betared t^\prime$ then $\exists\ A^\prime.$ $A \equiv A^\prime$ and $\Gamma \vdash t^\prime \cinfr A^\prime$
        \item $\Gamma \vdash t \chck A$ and $t \betared t^\prime$ then $\Gamma \vdash t^\prime \chck A$
        \item $\Gamma \vdash t \chck A$ and $A \betared A^\prime$ then $\Gamma \vdash t \chck A^\prime$
        \item $\Gamma \vdash t \infr A$ and $\Gamma \betastar \Gamma^\prime$ then $\exists\ A^\prime.$ $A \betastar A^\prime$ and $\Gamma^\prime \vdash t \infr A^\prime$
        \item $\Gamma \vdash t \cinfr A$ and $\Gamma \betastar \Gamma^\prime$ then $\exists\ A^\prime.$ $A \betastar A^\prime$ and $\Gamma^\prime \vdash t \cinfr A^\prime$
        \item $\vdash \Gamma$ and $\Gamma \betastar \Gamma^\prime$ then $\vdash \Gamma^\prime$
        \item $\Gamma \vdash t \infr A$, $\Gamma \betastar \Gamma^\prime$, and $t \betastar t^\prime$ then $\exists\ A^\prime.$ $A \equiv A^\prime$ and $\Gamma^\prime \vdash t^\prime \infr A^\prime$
        \item $\Gamma \vdash t \cinfr A$, $\Gamma \betastar \Gamma^\prime$, and $t \betastar t^\prime$ then $\exists\ A^\prime.$ $A \equiv A^\prime$ and $\Gamma^\prime \vdash t^\prime \cinfr A^\prime$
        \item $\Gamma \vdash t \chck A$, $\Gamma \betastar \Gamma^\prime$, $t \betastar t^\prime$, and $A \betastar A^\prime$ then $\Gamma^\prime \vdash t^\prime \chck A^\prime$
    \end{enumerate}
\end{theorem}
\begin{proof}
    The proof proceeds by well-founded mutual recursion.

    \textbf{\textit{1.}} By pattern-match on $\Gamma \vdash t \infr A$.
    The \textsc{Refl}, \textsc{Int}, \textsc{Fst}, and \textsc{PrmFst} cases are omitted because they are very similar to the \textsc{Lam}, \textsc{Pi}, \textsc{Snd}, and \textsc{PrmSnd} cases respectively.

    $\text{Case: }\begin{array}{c} \AxiomRule[*] \end{array}$
    \begin{proofcase}
        Applying \textit{4} to $\D{1}$ gives $\vdash \Gamma^\prime$.
        The \textsc{Ax} rule concludes the case.
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \VarRule[*] \end{array}$
    \begin{proofcase}
        Applying \textit{4} to $\D{1}$ gives $\vdash \Gamma^\prime$.
        Suppose wlog that $A \betared A^\prime$ in $\Gamma \betared \Gamma^\prime$.
        Then $(x_m : A^\prime) \in \Gamma^\prime$.
        Thus, $\Gamma^\prime \vdash x \infr A^\prime$.
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \PiRule[*] \end{array}$
    \begin{proofcase}
        Applying \textit{2} on $\D{1}$ gives $\Gamma^\prime \vdash A \cinfr T$ with $\pdom(m, K) \betastar T$, but this reduction forces $T = \pdom(m, K)$.
        Note that $\Gamma, x_m : A \betared \Gamma^\prime, x_m : A$.
        Applying \textit{2} on $\D{2}$ with the previous reduction gives $\Gamma^\prime, x_m : A \vdash B \cinfr \pcodom(m)$.
        Where the reduction-inferred type is $\pcodom(m)$ for the same reason as previously.
        The \textsc{Pi} rule concludes.
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \LambdaRule[*] \end{array}$
    \begin{proofcase}
        As with the previous case: $\Gamma^\prime \vdash A \cinfr \pdom(m, K)$.
        Applying \textit{1} on $\D{2}$ gives $\Gamma^\prime, x_m : A \vdash t \infr B^\prime$ with $B \betastar B^\prime$.
        Now, applying \textit{13} to $\D{3}$ yields $\Gamma^\prime, x_m : A \vdash B^\prime \cinfr \pcodom(m)$ noting that the reduction-inferred type is unchanged for the same reasons as before.
        Thus, $\Gamma^\prime \vdash \abs{\lambda_m}{x}{A}{t} \infr (x : A) \to_m B^\prime$ with $(x : A) \to_m B \betastar (x : A) \to_m B^\prime$.
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \AppRule[*] \end{array}$
    \begin{proofcase}
        Applying \textit{2} on $\D{1}$ gives $\Gamma^\prime \vdash f \cinfr T$ with $(x : A) \to_m B \betastar T$.
        By inversion on the previous reduction $T = (x : A^\prime) \to_m B^\prime$ with $A \betastar A^\prime$ and $B \betastar B^\prime$.
        Using \textit{14} on $\D{2}$ gives $\Gamma^\prime \vdash a \chck A^\prime$.
        Now by the \textsc{App} rule $\Gamma^\prime \vdash \app{f}{m}{a} \infr [x := a]B^\prime$.
        Finally, by Lemma~\ref{lem:2:betastar_subst} $[x := a]B \betastar [x:= a]B^\prime$.
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \PairRule[*] \end{array}$
    \begin{proofcase}
        Using \textit{1} on $\D{1}$ gives $\Gamma^\prime \vdash (x : A) \cap B \infr \star$.
        Again, note that technically a new term is introduced such that $\star \betastar T$, but this requires $T = \star$.
        Applying \textit{4} with $\D{2}$, $\D{3}$, and applying the \textsc{Pair} rule conclude the case.
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \SecondRule[*] \end{array}$
    \begin{proofcase}
        Using \textit{2} on $\D{1}$ gives $\Gamma^\prime \vdash t \cinfr T$ with $(x : A) \cap B \betastar T$.
        By inversion on this reduction $T = (x : A^\prime) \cap B^\prime$ with $A \betastar A^\prime$ and $B \betastar B^\prime$.
        Now with Lemma~\ref{lem:2:betastar_subst} $[x := t.1]B \betastar [x := t.1]B^\prime$.
        The \textsc{Snd} rule concludes.
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \EqualityRule[*] \end{array}$
    \begin{proofcase}
        Applying \textit{2} on $\D{1}$ gives $\Gamma^\prime \vdash A \cinfr \star$.
        Now using \textit{3} on $\D{2}$, $\D{3}$, and applying the \textsc{Eq} rule concludes the case.
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \SubstRule[*] \end{array}$
    \begin{proofcase}
        Using \textit{2} on $\D{1}$ yields $\Gamma^\prime \vdash e \cinfr T$ with $a =_A b \betastar T$.
        By inversion on the previous reduction $T = a^\prime =_{A^\prime} b^\prime$ with $a \betastar a^\prime$, $A \betastar A^\prime$, and $b \betastar b^\prime$.
        Note that $A \to_\tau \star \betastar A^\prime \to_\tau \star$ and using this with \textit{14} on $\D{2}$ gives $\Gamma^\prime \vdash P \chck A^\prime \to_\tau \star$.
        Finally, note that $\app{P}{\tau}{a} \to_\omega \app{P}{\tau}{b} \betastar \app{P}{\tau}{a^\prime} \to_\omega \app{P}{\tau}{b^\prime}$.
        Thus, the \textsc{Subst} rule concludes.
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \PromoteSndRule[*] \end{array}$
    \begin{proofcase}
        Using \textit{2} on $\D{1}$ gives $\Gamma^\prime \vdash a \cinfr T$ with $(x : A) \cap B \betastar T$.
        Inversion on this reduction gives $T = (x : A^\prime) \cap B^\prime$ with $A \betastar A^\prime$ and $B \betastar B^\prime$.
        By Lemma~\ref{lem:2:betastar_subst} $[x := a.1]B \betastar [x := a.1]B^\prime$.
        Thus, $a.2 =_{[x := a.1]B} = b.2 \betastar a.2 =_{[x := a.1]B^\prime} = b.2$.
        Using \textit{14} with the appropriate reductions and applying the \textsc{PrmSnd} rule concludes the case.
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \CastRule[*] \end{array}$
    \begin{proofcase}
        Using \textit{2} on $\D{1}$ gives $\Gamma^\prime \vdash f \cinfr T$ with $(a : A) \to_\omega (x : C) \cap B \betastar T$.
        Inversion on this previous reduction gives $T = (a : A^\prime) \to_\omega (x : C^\prime) \cap B^\prime$ with $A \betastar A^\prime$, $C \betastar C^\prime$, and $B \betastar B^\prime$.
        Note that $A \equiv C$ and thus by Lemma~\ref{lem:2:conv_red_f} $A^\prime \equiv C^\prime$.
        Now $(a : A) \to_\omega a =_A (\app{f}{\omega}{a}).1 \betastar (a : A^\prime) \to_\omega a =_{A^\prime} (\app{f}{\omega}{a}).1$.
        Using \textit{14} on $\D{3}$ also with the previous reduction gives $\Gamma^\prime \vdash e \chck (a : A^\prime) \to_\omega a =_{A^\prime} (\app{f}{\omega}{a}).1$.
        The \textsc{Cast} rule concludes the case.
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \SeparationRule[*] \end{array}$
    \begin{proofcase}
        Immediate by applying \textit{3} to $\D{1}$ and using the \textsc{Sep} rule.
    \end{proofcase}

    \textbf{\textit{2.}} By pattern-match on $\Gamma \vdash t \cinfr A$.

    $\text{Case: }\begin{array}{c} \HeadInferenceRule[*] \end{array}$
    \begin{proofcase}
        Using \textit{1} on $\D{1}$ gives $\Gamma^\prime \vdash t \infr A^\prime$ with $A \betastar A^\prime$.
        Confluence yields $B^\prime$ such that $A^\prime \betastar B^\prime$ and $B \betastar B^\prime$.
        Thus, $A \betastar B^\prime$ and the \textsc{RedInf} rule concludes.
    \end{proofcase}

    \textbf{\textit{3.}} By pattern-match on $\Gamma \vdash t \chck A$.

    $\text{Case: }\begin{array}{c} \CheckRule[*] \end{array}$
    \begin{proofcase}
        Using \textit{1} on $\D{2}$ gives $\Gamma^\prime \vdash t \cinfr A^\prime$ with $A \betastar A^\prime$.
        Suppose $B \neq \kind$ wlog.
        Applying \textit{2} on $\D{1}$ yields $\Gamma^\prime \vdash B \cinfr K$.
        Now by Lemma~\ref{lem:2:conv_red_f}: $A^\prime \equiv B$.
        Thus, $\Gamma^\prime \vdash t \chck B$.
    \end{proofcase}

    \textbf{\textit{4.}} By pattern-match on $\vdash \Gamma$.

    $\text{Case: }\begin{array}{c} \ContextEmptyRule[*] \end{array}$
    \begin{proofcase}
        Have $\varepsilon \betastar \Gamma^\prime$, but this forces $\Gamma^\prime = \varepsilon$.
        The \textsc{CtxEm} rule concludes the case.
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \ContextAppendRule[*] \end{array}$
    \begin{proofcase}
        Applying \textit{5} on $\D{2}$ gives $\vdash \Gamma^\prime$.
        Suppose wlog that $A \betared A^\prime$.
        Using \textit{13} on $\D{3}$ gives $\Gamma^\prime \vdash A^\prime \cinfr T$ where $T \equiv K$.
        Thus, $|T| \betastar K$.
        However, by Lemmas~\ref{lem:2:substar_not_beta_star} and $\kind$ not being a subexpression, this forces $T = K$.
        Note that context reduction does not create free variables, thus $x \notin FV(\Gamma^\prime)$.
        The \textsc{CtxApp} rule concludes.
    \end{proofcase}

    \textbf{\textit{5.}} By pattern-match on $\Gamma \vdash t \infr A$.

    \textbf{\textit{6.}} By pattern-match on $\Gamma \vdash t \cinfr A$.

    \textbf{\textit{7.}} By pattern-match on $\Gamma \vdash t \chck A$.

    \textbf{\textit{8.}} By pattern-match on $\Gamma \vdash t \chck A$.

    \textbf{\textit{9.}}

    \textbf{\textit{10.}}

    \textbf{\textit{11.}}

    \textbf{\textit{12.}}

    \textbf{\textit{13.}}

    \textbf{\textit{14.}}


\end{proof}

% \begin{lemma}
%     Suppose $\Gamma \vdash a \chck A$ and $A \equiv A^\prime$
%     \textcolor{white}{\_}
%     \begin{enumerate}
%         \item If $\Gamma, x : A^\prime, \Delta \vdash t \infr K$ then $\Gamma, [x := a]\Delta \vdash [x := a]t \infr K$
%         \item If $\Gamma, x : A^\prime, \Delta \vdash t \cinfr K$ then $\Gamma, [x := a]\Delta \vdash [x := a]t \cinfr K$
%         \item If $\Gamma, x : A^\prime, \Delta \vdash t \chck K$ then $\Gamma, [x := a]\Delta \vdash [x := a]t \chck K$
%         \item If $\vdash \Gamma, x : A^\prime, \Delta$ then $\vdash \Gamma, [x := a]\Delta$
%     \end{enumerate}
%     \label{lem:2:subst_check_type}
% \end{lemma}
% \begin{proof}
%     By mutual induction.

%     $\text{Case: }\begin{array}{c} \AxiomRule[*] \end{array}$
%     \begin{proofcase}
%         TODO
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \VarRule[*] \end{array}$
%     \begin{proofcase}
%         TODO
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \PiRule[*] \end{array}$
%     \begin{proofcase}
%         TODO
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \LambdaRule[*] \end{array}$
%     \begin{proofcase}
%         TODO
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \AppRule[*] \end{array}$
%     \begin{proofcase}
%         TODO
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \IntersectionRule[*] \end{array}$
%     \begin{proofcase}
%         TODO
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \PairRule[*] \end{array}$
%     \begin{proofcase}
%         TODO
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \FirstRule[*] \end{array}$
%     \begin{proofcase}
%         TODO
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \SecondRule[*] \end{array}$
%     \begin{proofcase}
%         TODO
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \EqualityRule[*] \end{array}$
%     \begin{proofcase}
%         TODO
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \ReflRule[*] \end{array}$
%     \begin{proofcase}
%         TODO
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \SubstRule[*] \end{array}$
%     \begin{proofcase}
%         TODO
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \PromoteFstRule[*] \end{array}$
%     \begin{proofcase}
%         TODO
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \PromoteSndRule[*] \end{array}$
%     \begin{proofcase}
%         TODO
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \CastRule[*] \end{array}$
%     \begin{proofcase}
%         TODO
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \SeparationRule[*] \end{array}$
%     \begin{proofcase}
%         TODO
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \HeadInferenceRule[*] \end{array}$
%     \begin{proofcase}
%         TODO
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \CheckRule[*] \end{array}$
%     \begin{proofcase}
%         TODO
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \ContextEmptyRule[*] \end{array}$
%     \begin{proofcase}
%         TODO
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \ContextAppendRule[*] \end{array}$
%     \begin{proofcase}
%         TODO
%     \end{proofcase}
% \end{proof}

% \begin{lemma}
%     \textcolor{white}{\_}
%     \begin{enumerate}
%         \item If $\Gamma \vdash t \infr K$, $\Gamma \betared \Gamma^\prime$, and $t \betared t^\prime$ then $\Gamma^\prime \vdash t^\prime \infr K$
%         \item If $\Gamma \vdash t \cinfr K$, $\Gamma \betared \Gamma^\prime$, and $t \betared t^\prime$ then $\Gamma^\prime \vdash t^\prime \cinfr K$
%         \item If $\Gamma \vdash t \chck K$, $\Gamma \betared \Gamma^\prime$ and $t \betared t^\prime$ then $\Gamma^\prime \vdash t^\prime \chck K$
%         \item If $\vdash \Gamma$ and $\Gamma \betared \Gamma^\prime$ then $\vdash \Gamma^\prime$
%     \end{enumerate}
%     where $K = \star$ or $K = \kind$
%     \label{lem:b:type_preservation_step}
% \end{lemma}
% \begin{proof}
%     By mutual induction.
%     The \textsc{Lambda}, \textsc{Pair}, \textsc{Refl}, \textsc{Subst}, \textsc{PrmFst}, \textsc{PrmSnd}, \textsc{Cast}, and \textsc{Sep} cases are omitted because the inferred type cannot be equal to $K$.

%     $\text{Case: }\begin{array}{c} \AxiomRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \VarRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \PiRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \AppRule[*] \end{array}$
%     \begin{proofcase}
%         By cases on $t \betared t^\prime$.

%         $\text{Case: }\begin{array}{c} \app{(\abs{\lambda_m}{x}{Q}{b})}{m}{a} \betared [x := a]b \end{array}$
%         \begin{proofcase}
%             TODO
%         \end{proofcase}

%         $\text{Case: }\begin{array}{c} a \betared a^\prime \end{array}$
%         \begin{proofcase}
%         \end{proofcase}

%         $\text{Case: }\begin{array}{c} f \betared f^\prime \end{array}$
%         \begin{proofcase}
%         \end{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \IntersectionRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \FirstRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \SecondRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \EqualityRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \SubstRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \PromoteFstRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \PromoteSndRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \CastRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \SeparationRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \HeadInferenceRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \CheckRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \ContextEmptyRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \ContextAppendRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}
% \end{proof}


% \begin{lemma}
%     Suppose $\Gamma \vdash A^\prime \cinfr K$ and $A \betastar A^\prime$
%     \textcolor{white}{\_}
%     \begin{enumerate}
%         \item If $\Gamma, x : A, \Delta \vdash t \infr B$ then $\exists\ B^\prime.$ $B \betastar B^\prime$ and $\Gamma, x : A^\prime, \Delta \vdash t \infr B^\prime$
%         \item If $\Gamma, x : A, \Delta \vdash t \cinfr B$ then $\exists\ B^\prime.$ $B \betastar B^\prime$ and $\Gamma, x : A^\prime, \Delta \vdash t \cinfr B^\prime$
%         \item If $\Gamma, x : A, \Delta \vdash t \chck B$ then $\Gamma, x : A^\prime, \Delta \vdash t \chck B$
%         \item If $\vdash \Gamma, x : A, \Delta$ then $\vdash \Gamma, x : A^\prime, \Delta$
%     \end{enumerate}
%     \label{lem:2:check_ctx}
% \end{lemma}
% \begin{proof}
%     By mutual induction.
%     The \textsc{Int} rule is omitted as it is similar to the \textsc{Pi} rule.
%     Rules \textsc{Fst} and \textsc{PrmFst} are omitted because they are very similar to \textsc{Snd} and \textsc{PrmSnd} respectively.
%     The \textsc{Sep} and \textsc{Ax} rules are immediate by the IH and thus omitted.

%     $\text{Case: }\begin{array}{c} \VarRule[*] \end{array}$
%     \begin{proofcase}
%         Rename to $y : C$.
%         Applying the IH to $\D{1}$ gives $\vdash \Gamma, x : A^\prime, \Delta$.
%         If $y \neq x$ then $\Gamma, x : A^\prime, \Delta \vdash y \infr C$.
%         Otherwise, $\Gamma, x : A^\prime, \Delta \vdash y \infr A^\prime$ and $A = C$, but also $A \equiv A^\prime$.
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \PiRule[*] \end{array}$
%     \begin{proofcase}
%         Note that from past arguments $\pdom(m, K) \equiv T$ where $T$ is part of a judgment means that $T = \pdom(m, K)$ and likewise for $\pcodom(m)$.
%         With that in mind this case is discharge by the IH on both $\D{1}$ and $\D{2}$.
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \LambdaRule[*] \end{array}$
%     \begin{proofcase}
%         As with the previous case: $\Gamma, x : A^\prime, \Delta \vdash A \cinfr \pdom(m, K)$.
%         Applying the IH to $\D{2}$ gives $\exists\ B^\prime$ such that $B \equiv B^\prime$ and $\Gamma, x : A^\prime, \Delta, y : C \vdash t \infr B^\prime$.


%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \AppRule[*] \end{array}$
%     \begin{proofcase}
%         Applying the IH to $\D{1}$ gives $\exists\ T$ such that $(x : A) \to_m B \betastar T$ and $\Gamma, x_m : U^\prime, \Delta \vdash T$.
%         By inversion $T = (x : C) \to_m D$ where $A \betastar C$ and $B \betastar D$.

%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \PairRule[*] \end{array}$
%     \begin{proofcase}
%         TODO
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \SecondRule[*] \end{array}$
%     \begin{proofcase}
%         TODO
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \EqualityRule[*] \end{array}$
%     \begin{proofcase}
%         TODO
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \ReflRule[*] \end{array}$
%     \begin{proofcase}
%         TODO
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \SubstRule[*] \end{array}$
%     \begin{proofcase}
%         TODO
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \PromoteSndRule[*] \end{array}$
%     \begin{proofcase}
%         TODO
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \CastRule[*] \end{array}$
%     \begin{proofcase}
%         TODO
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \HeadInferenceRule[*] \end{array}$
%     \begin{proofcase}
%         By the IH applied to $\D{1}$: $\exists\ T$ such that $C \equiv T$ and $\Gamma, x : A^\prime, \Delta \vdash t \infr T$.
%         Pick $B^\prime = T$.
%         Now by Lemma~\ref{lem:2:conv_red_f} applied with $\D{2}$ to $C \equiv T$: $B \equiv T$.
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \CheckRule[*] \end{array}$
%     \begin{proofcase}
%         Applying the IH to $\D{2}$ gives $\exists\ C^\prime$ such that $C \equiv C^\prime$ and $\Gamma, x : A^\prime, \Delta \vdash t \infr C^\prime$.
%         By Lemma~\ref{thm:2:conv_trans}: $C \equiv B$.
%         W.l.o.g. assume $\Gamma, x : A, \Delta \vdash B \cinfr K$.
%         Using the IH on this derivation gives $\exists\ T$ such that $T \equiv K$ and $\Gamma, x : A^\prime, \Delta \vdash B \cinfr T$.
%         For any possibility of $K = \star$ or $K = \kind$ it forces $T = K$.
%         Thus, $\Gamma, x : A^\prime, \Delta \vdash t \chck B$.
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \ContextEmptyRule[*] \end{array}$
%     \begin{proofcase}
%         Impossible, premise assumes the context is non-empty.
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \ContextAppendRule[*] \end{array}$
%     \begin{proofcase}
%         Rename to $y : C$.
%         Have $\vdash \Gamma, x : A, \Delta, y : C$.
%         By the IH applied to $\D{2}$: $\vdash \Gamma, x : A^\prime, \Delta$.
%         Applying the IH to $\D{3}$ gives $\exists\ T$ such that $K \equiv T$ and $\Gamma, x : A^\prime, \Delta \vdash C \cinfr T$.
%         Note if $K = \kind$ then $T = \kind$ because of Lemma~\ref{lem:2:kind_not_type}.
%         If $K = \star$ then $T = \star$ by Lemma~\ref{lem:2:star_type_valid}.
%         Thus, $\vdash \Gamma, x : A^\prime, \Delta, y : C$.
%     \end{proofcase}
% \end{proof}

% \begin{lemma}[Substitution of Checking]
%     Suppose $\Gamma \vdash b \infr B^\prime$ and $B^\prime \equiv B$.
%     \begin{enumerate}
%         \item If $\Gamma, x : B, \Delta \vdash t \infr A$ then $\exists\ A^\prime.$ $A \equiv A^\prime$ and $\Gamma, [x := b]\Delta \vdash [x := b]t \infr [x := b]A^\prime$
%         \item If $\Gamma, x : B, \Delta \vdash t \cinfr A$ then $\exists\ A^\prime.$ $A \equiv A^\prime$ and $\Gamma, [x := b]\Delta \vdash [x := b]t \cinfr [x := b]A^\prime$
%         \item If $\Gamma, x : B, \Delta \vdash t \chck A$ then $\Gamma, [x := b]\Delta \vdash [x := b]t \chck [x := b]A$
%         \item If $\vdash \Gamma, x : B, \Delta$ then $\vdash \Gamma, [x := b]\Delta$
%     \end{enumerate}
%     \label{lem:2:subst_check}
% \end{lemma}

% \begin{proof}
%     By mutual induction.

%     $\text{Case: }\begin{array}{c} \AxiomRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \VarRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \PiRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \LambdaRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \AppRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \IntersectionRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \PairRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \FirstRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \SecondRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \EqualityRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \ReflRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \SubstRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \PromoteFstRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \PromoteSndRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \CastRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \SeparationRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \HeadInferenceRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \CheckRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \ContextEmptyRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \ContextAppendRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}
% \end{proof}

% % \begin{proof}
% %     Deconstructing $\Gamma \vdash b \chck B$ gives $\exists\ T$ such that $\Gamma \vdash b \infr T$, $\Gamma \vdash T \cinfr K$, and $T \equiv B$.
% %     \begin{enumerate}
% %         \item[1.-3.] {
% %             By Lemma~\ref{lem:2:check_ctx}: $\Gamma, x : T, \Delta \vdash t \chck A$.
% %             Applying Lemma~\ref{lem:2:subst_infer} gives $\Gamma, [x := b]\Delta \vdash [x := b]t \chck [x := b]A$.
% %         }
% %         \item[4.] {
% %             By Lemma~\ref{lem:2:check_ctx}: $\vdash \Gamma, x : T, \Delta$.
% %             Applying Lemma~\ref{lem:2:subst_infer} gives $\vdash \Gamma, [x := b]\Delta$.
% %         }
% %     \end{enumerate}
% % \end{proof}

% \begin{lemma}
%     If $\Gamma \vdash a \chck T$, $\Gamma \vdash A \cinfr K$, and $T \equiv A$ then $\Gamma \vdash a \chck A$
%     \label{lem:2:check_preserved_by_conv}
% \end{lemma}
% \begin{proof}
%     Deconstruct $\Gamma \vdash a \chck T$ to obtain $\exists\ T^\prime$ such that $\Gamma \vdash a \infr T^\prime$, $\Gamma \vdash T^\prime \cinfr K$, and $T^\prime \equiv T$.
%     Note that by Lemma~\ref{lem:2:infer_is_pseobj} and Lemma~\ref{lem:2:infer_type_is_pseobj} $A, T, T^\prime\pseobj$.
%     Thus, by Lemma~\ref{thm:2:conv_trans} $T \equiv A$.
%     Therefore, $\Gamma \vdash a \chck A$.
% \end{proof}


% \begin{lemma}
%     \textcolor{white}{\_}
%     \begin{enumerate}
%         \item If $\Gamma \vdash t \infr A$, $\Gamma \betared \Gamma^\prime$, and $t \betared t^\prime$ then $\exists\ B.$ $A \equiv B$ and $\Gamma^\prime \vdash t^\prime \infr B$
%         \item If $\Gamma \vdash t \cinfr A$, $\Gamma \betared \Gamma^\prime$, and $t \betared t^\prime$ then $\exists\ B.$ $A \equiv B$ and $\Gamma^\prime \vdash t^\prime \cinfr B$
%         \item If $\Gamma \vdash t \chck A$, $\Gamma \betared \Gamma^\prime$, $t \betared t^\prime$, and $A \betared A^\prime$ then $\Gamma^\prime \vdash t^\prime \chck A^\prime$
%         \item If $\vdash \Gamma$ and $\Gamma \betared \Gamma^\prime$ then $\vdash \Gamma^\prime$
%     \end{enumerate}
%     \label{lem:b:preservation_par_step}
% \end{lemma}
% \begin{proof}
%     By mutual induction.

%     $\text{Case: }\begin{array}{c} \AxiomRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \VarRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \PiRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \LambdaRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \AppRule[*] \end{array}$
%     \begin{proofcase}
%         By cases on $t \betared t^\prime$.

%         $\text{Case: }\begin{array}{c} \app{(\abs{\lambda_m}{x}{Q}{b})}{m}{a} \betared [x := a]b \end{array}$
%         \begin{proofcase}
%             Have $\Gamma \vdash \abs{\lambda_m}{x}{Q}{b} \cinfr (x : A) \to_m B$, thus $\exists\ T$ such that $T \betastar (x : A) \to_m B$ and $\Gamma \vdash \abs{\lambda_m}{x}{Q}{b} \infr T$.
%             By inversion on $T \betastar (x : A) \to_m B$: $T = (x : C) \to_m D$ where $C \betastar A$ and $D \betastar B$.
%             Note $Q = C$ by inversion.
%             Thus, $\Gamma \vdash \abs{\lambda_m}{x}{C}{b} \infr (x : C) \to_m D$.
%             Deconstructing gives $\Gamma, x : C \vdash t \infr D$.
%             Deconstructing $\D{2}$ yields $\exists\ T$ such that $\Gamma \vdash a \infr T$ and $T \equiv A$.

%         \end{proofcase}

%         $\text{Case: }\begin{array}{c} a \betared a^\prime \end{array}$
%         \begin{proofcase}
%         \end{proofcase}

%         $\text{Case: }\begin{array}{c} f \betared f^\prime \end{array}$
%         \begin{proofcase}
%         \end{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \IntersectionRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \PairRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \FirstRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \SecondRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \EqualityRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \ReflRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \SubstRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \PromoteFstRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \PromoteSndRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \CastRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \SeparationRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \HeadInferenceRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \CheckRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \ContextEmptyRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}

%     $\text{Case: }\begin{array}{c} \ContextAppendRule[*] \end{array}$
%     \begin{proofcase}
%     \end{proofcase}
% \end{proof}
