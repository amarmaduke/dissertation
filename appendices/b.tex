\chapter{Proof of Preservation}
\label{ap:b}

\begin{lemma}
    \textcolor{white}{\_}
    \begin{enumerate}
        \item If $\Gamma \vdash t \infr A$, $\Gamma \parred \Gamma^\prime$, and $t \parred t^\prime$ then $\exists\ B.$ $A \equiv B$ and $\Gamma^\prime \vdash t^\prime \infr B$
        \item If $\Gamma \vdash t \cinfr A$, $\Gamma \parred \Gamma^\prime$, and $t \parred t^\prime$ then $\exists\ B.$ $A \equiv B$ and $\Gamma^\prime \vdash t^\prime \cinfr B$
        \item If $\Gamma \vdash t \chck A$, $\Gamma \parred \Gamma^\prime$, $t \parred t^\prime$, and $A \parred A^\prime$ then $\Gamma^\prime \vdash t^\prime \chck A^\prime$
        \item If $\vdash \Gamma$ and $\Gamma \parred \Gamma^\prime$ then $\vdash \Gamma^\prime$
    \end{enumerate}
    \label{lem:b:preservation_par_step}
\end{lemma}
\begin{proof}
    By mutual induction.

    $\text{Case: }\begin{array}{c} \AxiomRule[*] \end{array}$
    \begin{proofcase}
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \VarRule[*] \end{array}$
    \begin{proofcase}
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \PiRule[*] \end{array}$
    \begin{proofcase}
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \LambdaRule[*] \end{array}$
    \begin{proofcase}
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \AppRule[*] \end{array}$
    \begin{proofcase}
        By cases on $t \parred t^\prime$.

        $\text{Case: }\begin{array}{c} \ParBetaReduction[*] \end{array}$
        \begin{proofcase}
            Applying the IH to the outer $\D{1}$ gives $\exists\ T_1$ such that $(x : A) \to_m B \equiv T_1$ and $\Gamma^\prime \vdash \abs{\lambda_m}{x}{t_1^\prime}{t_2^\prime} \chck T_1$.
            By definition, $\exists\ T_2$ such that $\Gamma^\prime \vdash \abs{\lambda_m}{x}{t_1^\prime}{t_2^\prime} \infr T_2$, $\Gamma^\prime \vdash T_1 \cinfr K$, and $T_1 \equiv T_2$.
            Inversion on the subsequent rule gives $\exists\ C, D$ such that $T_2 = (x : C) \to_m D$ and $t_1^\prime = C$.
            Using Lemma~\ref{lem:2:infer_is_pseobj} and Theorem~\ref{thm:2:conv_trans}: $(x : A) \to_m B \equiv (x : C) \to_m D$ which means $A \equiv C$ and $B \equiv D$.
            The IH used on $\D{2}$ yields $\Gamma^\prime \vdash t_3^\prime \chck A$.
            Applying Theorem~\ref{thm:2:conv_trans} to this gives $\Gamma^\prime \vdash t_3^\prime \chck C$.
            Note that $\Gamma^\prime, x : C \vdash t_2^\prime \infr D$.
            By Lemma~\ref{lem:2:subst_check}: $\Gamma^\prime \vdash [x := t_3^\prime]t_2^\prime \chck [x := t_3^\prime]D$.
            Finally, $[x := t_3]B \equiv [x := t_3^\prime]D$ by Lemma~\ref{lem:2:conv_subst}.
        \end{proofcase}

        $\text{Case: }\begin{array}{c} \ParConstructorReduction[*] \end{array}$
        \begin{proofcase}
            TODO
        \end{proofcase}
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \IntersectionRule[*] \end{array}$
    \begin{proofcase}
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \PairRule[*] \end{array}$
    \begin{proofcase}
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \FirstRule[*] \end{array}$
    \begin{proofcase}
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \SecondRule[*] \end{array}$
    \begin{proofcase}
        By cases on $t \parred t^\prime$.

        $\text{Case: }\begin{array}{c} \ParSndReduction[*] \end{array}$
        \begin{proofcase}
           % Goal: find B' such that [x := t.1]B \parred B' and G' |- t'.2 : B'


        \end{proofcase}

        $\text{Case: }\begin{array}{c} \ParConstructorReduction[*] \end{array}$
        \begin{proofcase}
        \end{proofcase}
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \EqualityRule[*] \end{array}$
    \begin{proofcase}
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \ReflRule[*] \end{array}$
    \begin{proofcase}
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \SubstRule[*] \end{array}$
    \begin{proofcase}
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \PromoteFstRule[*] \end{array}$
    \begin{proofcase}
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \PromoteSndRule[*] \end{array}$
    \begin{proofcase}
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \CastRule[*] \end{array}$
    \begin{proofcase}
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \SeparationRule[*] \end{array}$
    \begin{proofcase}
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \HeadInferenceRule[*] \end{array}$
    \begin{proofcase}
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \CheckRule[*] \end{array}$
    \begin{proofcase}
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \ContextEmptyRule[*] \end{array}$
    \begin{proofcase}
        By inversion on $\varepsilon \parred \Gamma^\prime$: $\Gamma^\prime = \varepsilon$.
    \end{proofcase}

    $\text{Case: }\begin{array}{c} \ContextAppendRule[*] \end{array}$
    \begin{proofcase}
    \end{proofcase}
\end{proof}